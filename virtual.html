<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>駐車場 空き状況ナビ（完全版）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { font-family:sans-serif; background:#cfcfcf; padding:8px; margin:0; text-align:center; }
h1 { font-size:clamp(18px,4vw,26px); margin:6px 0; }
#location,#orientation { background:#fff; padding:6px 8px; margin-bottom:6px; border-radius:6px; font-size:13px; }
button { padding:6px 10px; font-size:14px; margin:2px; }
#controller { margin-bottom:8px; }

#zoom-slider-container {
  margin: 8px auto;
  width: 90%;
}
#zoom-slider { width: 100%; }

#parking-lot-container {
  position:relative;
  width:100%; max-width:900px; aspect-ratio:9/6.5;
  margin:auto; overflow:hidden; border-radius:10px; background:#bfbfbf; cursor:crosshair;
}

#parking-lot {
  position:absolute; width:100%; height:100%;
  top:0; left:0;
  transform-origin:50% 50%;
}

.rod {
  position:absolute;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:white; font-weight:bold; font-size:14px; /* 文字は固定 */
  border-top:3px solid white; border-bottom:3px solid white;
  box-sizing:border-box;
}
.empty{background:#4caf50;} .full{background:#f44336;}
#user-marker{position:absolute; width:14px; height:14px; background:#2196f3; border-radius:50%; border:2px solid white; z-index:1001; top:50%; left:50%; transform:translate(-50%,-50%);}
.user-marker-other{position:absolute;width:12px;height:12px;background:#ff9800;border:2px solid white;border-radius:50%;z-index:1000;}

/* 自分の向き矢印 */
#heading-arrow {
  position:absolute; width:2px; height:14px; background:red; z-index:1002;
  top:50%; left:50%; transform-origin:bottom center; transform:translate(-50%,-100%) rotate(0deg);
}
#heading-arrow::after {
  content:""; position:absolute; bottom:100%; left:-4px;
  border-left:5px solid transparent; border-right:5px solid transparent; border-bottom:10px solid red;
}
</style>
</head>
<body>
<h1>駐車場 空き状況ナビ（完全版）</h1>
<div id="location">現在地を設定してください</div>
<div id="orientation">向き：未取得</div>
<button id="enable-orientation">方位センサを有効化</button>

<div id="zoom-slider-container">
  <input type="range" id="zoom-slider" min="0.8" max="2.5" value="1.8" step="0.01">
</div>

<div id="controller">
  <button id="up">↑</button><br>
  <button id="left">←</button>
  <button id="down">↓</button>
  <button id="right">→</button>
</div>

<div id="parking-lot-container">
  <div id="parking-lot"></div>
  <div id="user-marker"></div>
  <div id="heading-arrow"></div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const MIN_LAT=38.16742, MAX_LAT=38.16752;
const MIN_LNG=140.86561, MAX_LNG=140.86591;

const rods=[
 {id:"A1",lat:38.16748,lng:140.86561,status:0,row:1,col:1},
 {id:"A2",lat:38.16746,lng:140.86561,status:1,row:2,col:1},
 {id:"A3",lat:38.16744,lng:140.86561,status:0,row:3,col:1},
 {id:"B1",lat:38.16748,lng:140.86591,status:0,row:1,col:3},
 {id:"B2",lat:38.16746,lng:140.86591,status:1,row:2,col:3},
 {id:"B3",lat:38.16744,lng:140.86591,status:0,row:3,col:3}
];

let userLat = (MIN_LAT+MAX_LAT)/2;
let userLng = (MIN_LNG+MAX_LNG)/2;
let deviceHeading=null;
let zoomScale = 1.8; // 初期サイズ大きめ

const lot=document.getElementById("parking-lot");
const container=document.getElementById("parking-lot-container");

const SOCKET_URL = "https://parking-monitor-fr8a.onrender.com";
const socket = io(SOCKET_URL, { transports: ["websocket","polling"] });

const others = {}; 

function gpsToRelative(lat,lng){
  const dx = (lng - userLng) / (MAX_LNG-MIN_LNG) * 100;
  const dy = (userLat - lat) / (MAX_LAT-MIN_LAT) * 100;
  return {x: dx, y: dy};
}

function renderRods(){
  document.querySelectorAll(".rod").forEach(e=>e.remove());
  rods.forEach(r=>{
    const d=document.createElement("div");
    d.className="rod "+(r.status===0?"empty":"full");
    d.innerHTML=`${r.id}<br>${r.status===0?"空き":"使用中"}`;
    lot.appendChild(d);
  });
}
renderRods();

container.addEventListener("click", e=>{
 const rect=container.getBoundingClientRect();
 const x=e.clientX-rect.left, y=e.clientY-rect.top;
 userLat=MAX_LAT-(y/lot.clientHeight)*(MAX_LAT-MIN_LAT);
 userLng=MIN_LNG+(x/lot.clientWidth)*(MAX_LNG-MIN_LNG);
});

const moveStepLat=(MAX_LAT-MIN_LAT)/50;
const moveStepLng=(MAX_LNG-MIN_LNG)/50;
function moveUp(){ if(userLat!==null) userLat+=moveStepLat; }
function moveDown(){ if(userLat!==null) userLat-=moveStepLat; }
function moveLeft(){ if(userLng!==null) userLng-=moveStepLng; }
function moveRight(){ if(userLng!==null) userLng+=moveStepLng; }

document.getElementById("up").onclick=moveUp;
document.getElementById("down").onclick=moveDown;
document.getElementById("left").onclick=moveLeft;
document.getElementById("right").onclick=moveRight;

window.addEventListener("keydown", e=>{
 switch(e.key){
  case "ArrowUp": moveUp(); break;
  case "ArrowDown": moveDown(); break;
  case "ArrowLeft": moveLeft(); break;
  case "ArrowRight": moveRight(); break;
 }
});

document.getElementById("enable-orientation").onclick=async()=>{
 if(typeof DeviceOrientationEvent?.requestPermission==="function"){
  const res=await DeviceOrientationEvent.requestPermission();
  if(res!=="granted") return alert("方位センサが許可されていません");
 }
 window.addEventListener("deviceorientation", e=>{
  if(e.webkitCompassHeading!=null) deviceHeading=e.webkitCompassHeading;
  else if(e.alpha!=null) deviceHeading=360-e.alpha;
  document.getElementById("orientation").textContent=`向き：${deviceHeading?.toFixed(0)}°`;
 });
};

document.getElementById("zoom-slider").addEventListener("input", e=>{
  zoomScale = parseFloat(e.target.value);
});

socket.on("positions", data=>{
  for(const id in data){
    if(id === socket.id) continue; 
    if(!others[id]){
      const m = document.createElement("div");
      m.className = "user-marker-other";
      lot.appendChild(m);
      others[id] = { marker: m, lat:data[id].lat, lng:data[id].lng };
    } else {
      others[id].lat = data[id].lat;
      others[id].lng = data[id].lng;
    }
  }
  for(const id in others){
    if(!data[id]){
      lot.removeChild(others[id].marker);
      delete others[id];
    }
  }
});

function sendMyPosition(){
 if(userLat!==null) socket.emit("update_position",{lat:userLat,lng:userLng});
}

(function loop(){
 if(userLat!==null && userLng!==null){
  document.getElementById("location").textContent=
   `現在地（開発）：${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;

  document.querySelectorAll(".rod").forEach((d,i)=>{
    const r = rods[i];
    const rel = gpsToRelative(r.lat,r.lng);
    const baseWidth = 80;  // 幅大きめ
    const baseHeight = 50; // 高さ大きめ
    d.style.width = `${baseWidth*zoomScale}px`;
    d.style.height = `${baseHeight*zoomScale}px`;
    d.style.left = (lot.clientWidth/2 + rel.x*zoomScale - (baseWidth*zoomScale)/2) + "px";
    d.style.top  = (lot.clientHeight/2 + rel.y*zoomScale - (baseHeight*zoomScale)/2) + "px";
  });

  for(const id in others){
    const o = others[id];
    const rel = gpsToRelative(o.lat,o.lng);
    o.marker.style.left = (lot.clientWidth/2 + rel.x*zoomScale -6) + "px";
    o.marker.style.top  = (lot.clientHeight/2 + rel.y*zoomScale -6) + "px";
  }

  if(deviceHeading!=null){
    lot.style.transform = `rotate(${-deviceHeading}deg) scale(${zoomScale})`;
  } else {
    lot.style.transform = `scale(${zoomScale})`;
  }

  sendMyPosition();
 }
 requestAnimationFrame(loop);
})();
</script>
</body>
</html>