<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>駐車場 自動ルート案内（サンプル）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { font-family:sans-serif; background:#cfcfcf; padding:8px; margin:0; text-align:center; }
h1 { font-size:clamp(18px,4vw,26px); margin:6px 0; }
#location { background:#fff; padding:6px 8px; margin-bottom:6px; border-radius:6px; font-size:13px; }
#parking-lot-container {
  position:relative; width:100%; max-width:900px; aspect-ratio:9/6.5;
  margin:auto; overflow:hidden; border-radius:10px; background:#bfbfbf;
}
#parking-lot {
  position:absolute; width:100%; height:100%; top:0; left:0;
}
.rod { position:absolute; width:33.33%; height:22%;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:white; font-weight:bold; font-size:clamp(14px,3.5vw,24px);
  border-top:3px solid white; border-bottom:3px solid white;
}
.empty{background:#4caf50;} .full{background:#f44336;}
#user-marker{position:absolute; width:14px; height:14px; background:#2196f3; border-radius:50%; border:2px solid white; top:50%; left:50%; transform:translate(-50%,-50%);}
.route-line{stroke:red; stroke-width:4; fill:none; marker-end:url(#arrow);}
</style>
</head>
<body>
<h1>駐車場 自動ルート案内（サンプル）</h1>
<div id="location">現在地（開発モード）</div>

<div id="parking-lot-container">
  <svg id="route-svg" width="100%" height="100%">
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
        <path d="M0,0 L10,5 L0,10 Z" fill="red"></path>
      </marker>
    </defs>
  </svg>
  <div id="parking-lot"></div>
  <div id="user-marker"></div>
</div>

<script>
/* ==== 駐車場範囲 ==== */
const MIN_LAT=38.16742, MAX_LAT=38.16752;
const MIN_LNG=140.86561, MAX_LNG=140.86591;

/* ==== ロッド ==== */
const rods=[
 {id:"A1",lat:38.16748,lng:140.86561,status:0,row:1,col:1},
 {id:"A2",lat:38.16746,lng:140.86561,status:1,row:2,col:1},
 {id:"A3",lat:38.16744,lng:140.86561,status:0,row:3,col:1},
 {id:"B1",lat:38.16748,lng:140.86591,status:0,row:1,col:3},
 {id:"B2",lat:38.16746,lng:140.86591,status:1,row:2,col:3},
 {id:"B3",lat:38.16744,lng:140.86591,status:0,row:3,col:3}
];

/* ==== 開発モード初期位置 ==== */
let userLat = 38.16744, userLng = 140.86561; // 初期位置は左下

const lot=document.getElementById("parking-lot");
const svg=document.getElementById("route-svg");

/* ==== GPS→UI ==== */
function gpsToUI(lat,lng){
  const x = (lng-MIN_LNG)/(MAX_LNG-MIN_LNG)*lot.clientWidth;
  const y = (MAX_LAT-lat)/(MAX_LAT-MIN_LAT)*lot.clientHeight;
  return {x,y};
}

/* ==== ロッド描画 ==== */
function renderRods(){
  document.querySelectorAll(".rod").forEach(e=>e.remove());
  rods.forEach(r=>{
    const d=document.createElement("div");
    d.className="rod "+(r.status===0?"empty":"full");
    d.innerHTML=`${r.id}<br>${r.status===0?"空き":"使用中"}`;
    d.style.left=((r.col-1)/3*100)+"%";
    d.style.top=((r.row-1)*22+30)+"%";
    lot.appendChild(d);
  });
}
renderRods();

/* ==== 通路グラフ ==== */
const nodes = {
  A:{lat:38.16744,lng:140.86561}, B:{lat:38.16746,lng:140.86561}, C:{lat:38.16748,lng:140.86561},
  D:{lat:38.16744,lng:140.86591}, E:{lat:38.16746,lng:140.86591}, F:{lat:38.16748,lng:140.86591}
};
const edges = {
  A:{B:1,D:1}, B:{A:1,C:1,E:1}, C:{B:1,F:1},
  D:{A:1,E:1}, E:{B:1,D:1,F:1}, F:{C:1,E:1}
};

/* ==== A* アルゴリズム ==== */
function heuristic(a,b){
  const dx = gpsToUI(a.lat,a.lng).x - gpsToUI(b.lat,b.lng).x;
  const dy = gpsToUI(a.lat,a.lng).y - gpsToUI(b.lat,b.lng).y;
  return Math.sqrt(dx*dx+dy*dy);
}
function astar(start,goal){
  const openSet = [start];
  const cameFrom = {};
  const gScore = {}; const fScore = {};
  for(const n in nodes){ gScore[n]=Infinity; fScore[n]=Infinity; }
  gScore[start]=0; fScore[start]=heuristic(nodes[start],nodes[goal]);
  while(openSet.length){
    openSet.sort((a,b)=>fScore[a]-fScore[b]);
    const current = openSet.shift();
    if(current===goal){
      let path=[current];
      while(cameFrom[path[0]]) path.unshift(cameFrom[path[0]]);
      return path;
    }
    for(const neighbor in edges[current]){
      const tentative = gScore[current]+edges[current][neighbor];
      if(tentative<gScore[neighbor]){
        cameFrom[neighbor]=current;
        gScore[neighbor]=tentative;
        fScore[neighbor]=tentative+heuristic(nodes[neighbor],nodes[goal]);
        if(!openSet.includes(neighbor)) openSet.push(neighbor);
      }
    }
  }
  return [];
}

/* ==== 最遠の駐車場（右上）までの経路描画 ==== */
function drawRoute(){
  svg.querySelectorAll("path").forEach(p=>p.remove());
  const pathNodes = astar("A","F"); // A:初期位置、F:右上駐車場
  for(let i=0;i<pathNodes.length-1;i++){
    const p1 = gpsToUI(nodes[pathNodes[i]].lat,nodes[pathNodes[i]].lng);
    const p2 = gpsToUI(nodes[pathNodes[i+1]].lat,nodes[pathNodes[i+1]].lng);
    const line = document.createElementNS("http://www.w3.org/2000/svg","path");
    line.setAttribute("d",`M${p1.x},${p1.y} L${p2.x},${p2.y}`);
    line.classList.add("route-line");
    svg.appendChild(line);
  }
}
drawRoute();
</script>
</body>
</html>