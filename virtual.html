<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>駐車場 空き状況ナビ（完全版）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { font-family:sans-serif; background:#cfcfcf; padding:8px; margin:0; text-align:center; }
h1 { font-size:clamp(18px,4vw,26px); margin:6px 0; }
#location,#orientation { background:#fff; padding:6px 8px; margin-bottom:6px; border-radius:6px; font-size:13px; }
button { padding:6px 10px; font-size:14px; margin:2px; }
#controller { margin-bottom:8px; }

#parking-lot-container {
  position:relative; width:100%; max-width:900px; aspect-ratio:9/6.5;
  margin:auto; overflow:hidden; border-radius:10px; background:#bfbfbf;
}

#parking-lot {
  position:absolute; width:100%; height:100%;
  top:0; left:0;
}

.rod {
  position:absolute; width:33.33%; height:22%;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  color:white; font-weight:bold;
  border-top:3px solid white;
  border-bottom:3px solid white;
}
.empty{background:#4caf50;}
.full{background:#f44336;}

#user-marker{
  position:absolute;
  width:14px;height:14px;
  background:#2196f3;
  border-radius:50%;
  border:2px solid white;
  z-index:1001;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
}

.user-marker-other{
  position:absolute;
  width:12px;height:12px;
  background:#ff9800;
  border-radius:50%;
  border:2px solid white;
  z-index:1000;
}

/* 方位矢印（必ず自分マーカー基準） */
#heading-arrow{
  position:absolute;
  width:2px;height:16px;
  background:red;
  z-index:1002;
  top:50%;left:50%;
  transform-origin:bottom center;
  transform:translate(-50%,-100%) rotate(0deg);
}
#heading-arrow::after{
  content:"";
  position:absolute;
  bottom:100%;left:-4px;
  border-left:5px solid transparent;
  border-right:5px solid transparent;
  border-bottom:10px solid red;
}
</style>
</head>

<body>
<h1>駐車場 空き状況ナビ（完全版）</h1>
<div id="location"></div>
<div id="orientation">向き：未取得</div>
<button id="enable-orientation">方位センサを有効化</button>

<div id="controller">
  <button id="up">↑</button><br>
  <button id="left">←</button>
  <button id="down">↓</button>
  <button id="right">→</button>
</div>

<div id="parking-lot-container">
  <div id="parking-lot"></div>
  <div id="user-marker"></div>
  <div id="heading-arrow"></div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
/* ==== 駐車場範囲 ==== */
const MIN_LAT=38.16742, MAX_LAT=38.16752;
const MIN_LNG=140.86561, MAX_LNG=140.86591;

/* ==== ロッド ==== */
const rods=[
 {id:"A1",lat:38.16748,lng:140.86561,status:0},
 {id:"A2",lat:38.16746,lng:140.86561,status:1},
 {id:"A3",lat:38.16744,lng:140.86561,status:0},
 {id:"B1",lat:38.16748,lng:140.86591,status:0},
 {id:"B2",lat:38.16746,lng:140.86591,status:1},
 {id:"B3",lat:38.16744,lng:140.86591,status:0}
];

/* ==== 開発モード初期位置 ==== */
let userLat=(MIN_LAT+MAX_LAT)/2;
let userLng=(MIN_LNG+MAX_LNG)/2;
let deviceHeading=null;

const lot=document.getElementById("parking-lot");

/* ==== 相対座標変換（ズレ防止の核心） ==== */
function gpsToRelative(lat,lng){
  return {
    x:(lng-userLng)/(MAX_LNG-MIN_LNG)*lot.clientWidth,
    y:(userLat-lat)/(MAX_LAT-MIN_LAT)*lot.clientHeight
  };
}

/* ==== ロッド描画 ==== */
rods.forEach(r=>{
  const d=document.createElement("div");
  d.className="rod "+(r.status===0?"empty":"full");
  d.textContent=r.id;
  lot.appendChild(d);
});

/* ==== 開発モード移動 ==== */
const stepLat=(MAX_LAT-MIN_LAT)/60;
const stepLng=(MAX_LNG-MIN_LNG)/60;
up.onclick=()=>userLat+=stepLat;
down.onclick=()=>userLat-=stepLat;
left.onclick=()=>userLng-=stepLng;
right.onclick=()=>userLng+=stepLng;

/* ==== 方位センサ ==== */
enable-orientation.onclick=async()=>{
 if(DeviceOrientationEvent?.requestPermission){
  const r=await DeviceOrientationEvent.requestPermission();
  if(r!=="granted")return;
 }
 window.addEventListener("deviceorientation",e=>{
  deviceHeading=e.webkitCompassHeading??(360-e.alpha);
  orientation.textContent=`向き：${deviceHeading.toFixed(0)}°`;
 });
};

/* ==== メインループ ==== */
(function loop(){
 location.textContent=`現在地（開発）：${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;

 document.querySelectorAll(".rod").forEach((d,i)=>{
  const rel=gpsToRelative(rods[i].lat,rods[i].lng);
  d.style.left=(lot.clientWidth/2+rel.x)+"px";
  d.style.top =(lot.clientHeight/2+rel.y)+"px";
 });

 if(deviceHeading!=null){
  document.getElementById("heading-arrow").style.transform=
   `translate(-50%,-100%) rotate(${deviceHeading}deg)`;
 }
 requestAnimationFrame(loop);
})();
</script>
</body>
</html>