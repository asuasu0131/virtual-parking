<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>駐車場 空き状況ナビ（A* + ロッド描画 + 矢印）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { font-family:sans-serif; background:#cfcfcf; padding:8px; margin:0; text-align:center; }
h1 { font-size:clamp(18px,4vw,26px); margin:6px 0; }
#location,#orientation { background:#fff; padding:6px 8px; margin-bottom:6px; border-radius:6px; font-size:13px; }
button { padding:6px 10px; font-size:14px; margin:2px; }
#controller { margin-bottom:8px; }

#parking-lot-container {
  position:relative; width:100%; max-width:900px; aspect-ratio:9/6.5;
  margin:auto; overflow:hidden; border-radius:10px; background:#bfbfbf; cursor:crosshair;
}

#parking-lot {
  position:absolute; width:100%; height:100%;
  top:0; left:0;
}

.rod { position:absolute; width:40px; height:30px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:white; font-weight:bold; font-size:12px;
  border:2px solid white; border-radius:4px;
}
.empty{background:#4caf50;} .full{background:#f44336;}
#user-marker{position:absolute; width:14px; height:14px; background:#2196f3; border-radius:50%; border:2px solid white; z-index:1001; transform:translate(-50%,-50%);}
.path-line { position:absolute; width:2px; height:2px; background:yellow; z-index:999; }

/* 自分の向き矢印 */
#heading-arrow {
  position:absolute; width:2px; height:14px; background:red; z-index:1002;
  transform-origin:bottom center; transform:translate(-50%,-100%) rotate(0deg);
}
#heading-arrow::after {
  content:""; position:absolute; bottom:100%; left:-4px;
  border-left:5px solid transparent; border-right:5px solid transparent; border-bottom:10px solid red;
}
</style>
</head>
<body>
<h1>駐車場 空き状況ナビ（A* + ロッド + 矢印）</h1>
<div id="location">現在地を設定してください</div>
<div id="orientation">向き：未取得</div>
<button id="enable-orientation">方位センサを有効化</button>

<div id="controller">
  <button id="up">↑</button><br>
  <button id="left">←</button>
  <button id="down">↓</button>
  <button id="right">→</button>
</div>

<div id="parking-lot-container">
  <div id="parking-lot"></div>
  <div id="user-marker"></div>
  <div id="heading-arrow"></div>
</div>

<script>
const lot=document.getElementById("parking-lot");
const userMarker=document.getElementById("user-marker");
const headingArrow=document.getElementById("heading-arrow");

/* ==== ロッド（px座標） ==== */
const rods=[
 {id:"A1",x:100,y:50,status:0},
 {id:"A2",x:100,y:100,status:1},
 {id:"A3",x:100,y:150,status:0},
 {id:"B1",x:300,y:50,status:0},
 {id:"B2",x:300,y:100,status:1},
 {id:"B3",x:300,y:150,status:0} // 案内対象
];

/* ==== 通路ノード (px座標) ==== */
const nodes=[
  {id:"N1",x:90,y:40,edges:["N2"]},
  {id:"N2",x:90,y:100,edges:["N1","N3","N5"]},
  {id:"N3",x:90,y:150,edges:["N2","B3_NODE"]},
  {id:"B3_NODE",x:300,y:150,edges:["N3"]}
];

/* ==== 初期位置（開発モード） ==== */
let userX = 80, userY = 40;
let deviceHeading = null;
let pathLines=[];

/* ==== ロッド描画 ==== */
function renderRods(){
  document.querySelectorAll(".rod").forEach(e=>e.remove());
  rods.forEach(r=>{
    const d=document.createElement("div");
    d.className="rod "+(r.status===0?"empty":"full");
    d.style.left=r.x+"px";
    d.style.top=r.y+"px";
    d.innerHTML=`${r.id}<br>${r.status===0?"空き":"使用中"}`;
    lot.appendChild(d);
  });
}
renderRods();

/* ==== 開発モード移動 ==== */
const moveStep=10;
document.getElementById("up").onclick  = ()=>{ userY-=moveStep; update(); };
document.getElementById("down").onclick= ()=>{ userY+=moveStep; update(); };
document.getElementById("left").onclick= ()=>{ userX-=moveStep; update(); };
document.getElementById("right").onclick= ()=>{ userX+=moveStep; update(); };
window.addEventListener("keydown", e=>{
  switch(e.key){
    case "ArrowUp": userY-=moveStep; update(); break;
    case "ArrowDown": userY+=moveStep; update(); break;
    case "ArrowLeft": userX-=moveStep; update(); break;
    case "ArrowRight": userX+=moveStep; update(); break;
  }
});

/* ==== 方位センサ ==== */
document.getElementById("enable-orientation").onclick=async()=>{
 if(typeof DeviceOrientationEvent?.requestPermission==="function"){
  const res=await DeviceOrientationEvent.requestPermission();
  if(res!=="granted") return alert("方位センサが許可されていません");
 }
 window.addEventListener("deviceorientation", e=>{
  if(e.webkitCompassHeading!=null) deviceHeading=e.webkitCompassHeading;
  else if(e.alpha!=null) deviceHeading=360-e.alpha;
  document.getElementById("orientation").textContent=`向き：${deviceHeading?.toFixed(0)}°`;
 });
};

/* ==== A* ==== */
function heuristic(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
function astar(start,end){
  const open=[{node:start,g:0,f:heuristic(start,end),parent:null}];
  const closed=new Set();
  while(open.length>0){
    open.sort((a,b)=>a.f-b.f);
    const current=open.shift();
    if(current.node.id===end.id){
      const path=[];
      let c=current;
      while(c){ path.unshift(c.node); c=c.parent; }
      return path;
    }
    closed.add(current.node.id);
    current.node.edges.forEach(nid=>{
      if(closed.has(nid)) return;
      const neighbor=nodes.find(n=>n.id===nid);
      const g=current.g+heuristic(current.node,neighbor);
      const f=g+heuristic(neighbor,end);
      const exist=open.find(o=>o.node.id===neighbor.id);
      if(!exist || g<exist.g) open.push({node:neighbor,g,f,parent:current});
    });
  }
  return [];
}

/* ==== 経路描画 ==== */
function drawPath(path){
  pathLines.forEach(l=>lot.removeChild(l));
  pathLines=[];
  for(let i=0;i<path.length-1;i++){
    const l=document.createElement("div");
    l.className="path-line";
    const dx=path[i+1].x-path[i].x;
    const dy=path[i+1].y-path[i].y;
    const dist=Math.hypot(dx,dy);
    const angle=Math.atan2(dy,dx)*180/Math.PI;
    l.style.width=dist+"px";
    l.style.height="2px";
    l.style.left=path[i].x+"px";
    l.style.top=path[i].y+"px";
    l.style.transform=`rotate(${angle}deg)`;
    lot.appendChild(l);
    pathLines.push(l);
  }
}

/* ==== メイン更新 ==== */
function update(){
  document.getElementById("location").textContent=`現在地：${userX},${userY}`;
  userMarker.style.left=userX+"px";
  userMarker.style.top=userY+"px";

  const startNode=nodes.reduce((prev,curr)=>
    heuristic({x:userX,y:userY},curr) < heuristic({x:userX,y:userY},prev)?curr:prev
  );
  const endNode=nodes.find(n=>n.id==="B3_NODE");
  const path=astar(startNode,endNode);
  drawPath(path);

  // 矢印追従
  headingArrow.style.left=userX+"px";
  headingArrow.style.top=userY+"px";
  if(path.length>1){
    const dx=path[1].x - path[0].x;
    const dy=path[1].y - path[0].y;
    const angle=Math.atan2(dy,dx)*180/Math.PI;
    headingArrow.style.transform=`translate(-50%,-100%) rotate(${angle}deg)`;
  }
}
update();
</script>
</body>
</html>