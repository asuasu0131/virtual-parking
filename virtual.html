<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>駐車場 空き状況ナビ（開発モード＋方位表示）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body { font-family:sans-serif; background:#cfcfcf; padding:8px; margin:0; text-align:center; }
h1 { font-size:clamp(18px,4vw,26px); margin:6px 0; }
#location,#orientation { background:#fff; padding:6px 8px; margin-bottom:6px; border-radius:6px; font-size:13px; }
button { padding:6px 10px; font-size:14px; margin:2px; }
#controller { margin-bottom:8px; }
#parking-lot { position:relative; width:100%; max-width:900px; aspect-ratio:9/6.5; margin:auto; background:#bfbfbf; overflow:hidden; border-radius:10px; cursor:crosshair; }
.rod { position:absolute; width:33.33%; height:22%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:clamp(14px,3.5vw,24px); border-top:3px solid white; border-bottom:3px solid white; }
.empty{background:#4caf50;} .full{background:#f44336;}
.nearest{outline:4px solid yellow; box-shadow: 0 0 14px rgba(255,255,0,0.9);}
.distance{font-size:clamp(10px,2.5vw,14px); font-weight:normal;}
#user-marker{position:absolute; width:14px; height:14px; background:#2196f3; border-radius:50%; border:2px solid white; z-index:1001; display:none;}
.user-marker-other{position:absolute;width:12px;height:12px;background:#ff9800;border:2px solid white;border-radius:50%;z-index:999;}
/* ==== 方位矢印 ==== */
#heading-arrow {
  position:absolute;
  width:2px;
  height:10px;
  background:red;
  z-index:1000;
  display:none;
  transform-origin:bottom center;
}
#heading-arrow::after {
  content:"";
  position:absolute;
  bottom:100%;
  left:-4px;
  border-left:5px solid transparent;
  border-right:5px solid transparent;
  border-bottom:10px solid red;
}
</style>
</head>
<body>
<h1>駐車場 空き状況ナビ（開発モード＋方位表示）</h1>
<div id="location">現在地を設定してください</div>
<div id="orientation">向き：未取得</div>
<button id="enable-orientation">方位センサを有効化</button>

<div id="controller">
  <button id="up">↑</button><br>
  <button id="left">←</button>
  <button id="down">↓</button>
  <button id="right">→</button>
</div>

<div id="parking-lot">
  <div id="user-marker"></div>
  <div id="heading-arrow"></div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
/* ==== 駐車場範囲 ==== */
const MIN_LAT=38.16742, MAX_LAT=38.16752;
const MIN_LNG=140.86561, MAX_LNG=140.86591;

/* ==== ロッド ==== */
const rods=[
 {id:"A1",lat:38.16748,lng:140.86561,status:0,row:1,col:1},
 {id:"A2",lat:38.16746,lng:140.86561,status:1,row:2,col:1},
 {id:"A3",lat:38.16744,lng:140.86561,status:0,row:3,col:1},
 {id:"B1",lat:38.16748,lng:140.86591,status:0,row:1,col:3},
 {id:"B2",lat:38.16746,lng:140.86591,status:1,row:2,col:3},
 {id:"B3",lat:38.16744,lng:140.86591,status:0,row:3,col:3}
];

let userLat=null, userLng=null;
let displayedPos=null;
let deviceHeading=null;

const lot=document.getElementById("parking-lot");
const arrow=document.getElementById("heading-arrow");

/* ==== Socket.IO接続 ==== */
const SOCKET_URL = "https://parking-monitor-fr8a.onrender.com";
const socket = io(SOCKET_URL, { transports: ["websocket","polling"] });

/* ==== 他人の位置 ==== */
const others = {}; 

/* ==== GPS→UI ==== */
function gpsToUI(lat,lng){
 return { x:(lng-MIN_LNG)/(MAX_LNG-MIN_LNG)*lot.clientWidth, y:(MAX_LAT-lat)/(MAX_LAT-MIN_LAT)*lot.clientHeight };
}

/* ==== 描画 ==== */
function render(){
  document.querySelectorAll(".rod").forEach(e=>e.remove());
  rods.forEach(r=>{
    const d=document.createElement("div");
    d.className="rod "+(r.status===0?"empty":"full");
    d.innerHTML=`${r.id}<br>${r.status===0?"空き":"使用中"}`;
    d.style.left=((r.col-1)/3*100)+"%";
    d.style.top=((r.row-1)*22+30)+"%";
    lot.appendChild(d);
  });
}

/* ==== 初期表示：ロッドを描画 ==== */
render();  // ページロード時にロッドを表示

/* ==== 開発モード：クリック・コントローラー ==== */
lot.addEventListener("click", e=>{
 const rect=lot.getBoundingClientRect();
 const x=e.clientX-rect.left, y=e.clientY-rect.top;
 userLat=MAX_LAT-(y/lot.clientHeight)*(MAX_LAT-MIN_LAT);
 userLng=MIN_LNG+(x/lot.clientWidth)*(MAX_LNG-MIN_LNG);
});

const moveStepLat=(MAX_LAT-MIN_LAT)/50;
const moveStepLng=(MAX_LNG-MIN_LNG)/50;
function moveUp(){ if(userLat!==null) userLat+=moveStepLat; }
function moveDown(){ if(userLat!==null) userLat-=moveStepLat; }
function moveLeft(){ if(userLng!==null) userLng-=moveStepLng; }
function moveRight(){ if(userLng!==null) userLng+=moveStepLng; }

document.getElementById("up").onclick=moveUp;
document.getElementById("down").onclick=moveDown;
document.getElementById("left").onclick=moveLeft;
document.getElementById("right").onclick=moveRight;

window.addEventListener("keydown", e=>{
 switch(e.key){
  case "ArrowUp": moveUp(); break;
  case "ArrowDown": moveDown(); break;
  case "ArrowLeft": moveLeft(); break;
  case "ArrowRight": moveRight(); break;
 }
});

/* ==== 方位センサ ==== */
document.getElementById("enable-orientation").onclick=async()=>{
 if(typeof DeviceOrientationEvent?.requestPermission==="function"){
  const res=await DeviceOrientationEvent.requestPermission();
  if(res!=="granted") return alert("方位センサが許可されていません");
 }
 window.addEventListener("deviceorientation",e=>{
  if(e.webkitCompassHeading!=null) deviceHeading=e.webkitCompassHeading;
  else if(e.alpha!=null) deviceHeading=360-e.alpha;
  document.getElementById("orientation").textContent=`向き：${deviceHeading?.toFixed(0)}°`;
 });
};

/* ==== Socket.IO：他人の位置更新 ==== */
socket.on("positions", data=>{
  for(const id in data){
    if(id === socket.id) continue; 
    if(!others[id]){
      const m = document.createElement("div");
      m.className = "user-marker-other";
      lot.appendChild(m);
      others[id] = { marker: m };
    }
    const p = gpsToUI(data[id].lat,data[id].lng);
    others[id].marker.style.left = (p.x-6)+"px";
    others[id].marker.style.top = (p.y-6)+"px";
  }
  for(const id in others){
    if(!data[id]){
      lot.removeChild(others[id].marker);
      delete others[id];
    }
  }
});

/* ==== 自分の位置送信 ==== */
function sendMyPosition(){
 if(userLat!==null){
   socket.emit("update_position",{lat:userLat,lng:userLng});
 }
}

/* ==== ループ ==== */
(function loop(){
 if(userLat!==null){
  const t=gpsToUI(userLat,userLng);
  if(!displayedPos) displayedPos={x:t.x,y:t.y};
  displayedPos.x+=(t.x-displayedPos.x)*0.2;
  displayedPos.y+=(t.y-displayedPos.y)*0.2;

  const m=document.getElementById("user-marker");
  m.style.left=(displayedPos.x-7)+"px";
  m.style.top=(displayedPos.y-7)+"px";
  m.style.display="block";

  document.getElementById("location").textContent=
   `現在地（開発）：${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;

  // 矢印描画
  if(deviceHeading!==null){
    const arrowEl=document.getElementById("heading-arrow");
    const arrowHeight = 10;
    arrowEl.style.left = displayedPos.x + "px";
    arrowEl.style.top = (displayedPos.y - arrowHeight) + "px";
    arrowEl.style.display="block";
    arrowEl.style.transform=`rotate(${deviceHeading}deg)`;
  }

  sendMyPosition();
 }

 requestAnimationFrame(loop);
})();
</script>
</body>
</html>